<!DOCTYPE html>
<html>
  <head>
        <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
        <script type="text/javascript" src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/2.2.0/topojson.js"></script>
  </head>
  <body>
      <title>D3 Project</title>

      <style>
        #div {
        position: fixed;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        }
        .countries {
          fill: lightgray;
        }
        .states :hover {
          fill: red;
        }

        .counties {
          fill: lightgray;
          stroke-width: 0.5px;
        }
        .state-borders {
          fill: none;
          stroke: black;
          stroke-width: 1px;
          stroke-linejoin: round;
          stroke-linecap: round;
          pointer-events: none;
        }

        .graticule {
          fill: none;   
          stroke: lightgray;
          stroke-width: 0.5px;
          pointer-events: none;

        }

        .marker {
          pointer-events: none;
        }

        .selected-state {
          fill: blue;
        }
        
        
        </style>



        <div id="div">
          <svg></svg> 
        </div>


        
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/topojson.v2.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <script src="https://d3js.org/d3-drag.v1.min.js"></script>
        <script src="/D3/d3-legend.min.js"></script>
        <script>

        var svg = d3.select("svg");
          width = 960,
          height = 500;

          
          svg.call(d3.drag()
              .on("drag", function() {
                var rotation = projection.rotate();

                projection.rotate([rotation[0] + d3.event.dx * 0.3, rotation[1] - d3.event.dy * 0.3, rotation[2]]);
                svg.selectAll("path").attr("d", path);

                rotate[0] = rotation[0];
                rotate[1] = rotation[1];
                markLocation();
              }))


        var g = svg.append("g");
        
        var globePositionX, globePositionY;

        var chartDiv = document.getElementById("div");

        var projection = d3.geoOrthographic()
            .scale(300)
            .translate([width / 2, height / 2])
            .precision(0.1)
            .clipAngle(90);
            
        redraw();

       //This is a test

        var path = d3.geoPath().projection(projection);

        var color = d3.scalePow().exponent(1/1.5).domain([1,633]).range(["white", "green"]);
        var graticular = d3.geoGraticule();
        var airport_location = [];
/*
        d3.csv("/Test_Data/airports_edit.csv", function(data) {
          data.forEach(function (d,i) {
            airport_location[i] = 
            [{
              iata: d.iata,
              name: d.name,
              city:  d.city,
              state:  d.state,
              country:  d.country,
              latitude:  +d.latitude,
              longitude:  +d.longitude
            }]
          })
        }); */


        var airports = new Map();

        d3.csv("/Test_Data/Number_of_airports.csv", function(data){
          data.forEach(function(d,i) {
            airports.set(d.ID_number, d.Airports)
          });
        });

        
        d3.json("/Test_Data/airports.json", function(data){
          data.forEach(function (d,i) {
            airport_location[i] = 
            [{
              country: d.country,
              name: d.name,
              latitude:  +d.lat,
              longitude:  +d.lon
            }]
          })
        });

        var baseTime = Date.now();
        var rotate = [0, -15];
        var velocity = [0.25, 0];

        window.addEventListener("resize", redraw);
        var spinning = true;

        function redraw() {
          width = chartDiv.clientWidth;
          height = chartDiv.clientHeight;

          globePositionX = width * (1/2);
          globePositionY = height * (1/2);

          // Use the extracted size to set the size of an SVG element.
          svg
            .attr("width", width)
            .attr("height", height);  

          projection
            .scale(300)
            .translate([globePositionX, globePositionY])
            .precision(0.1)
            .clipAngle(90);
          
          svg.selectAll("circle")
            .attr("cx", globePositionX)
            .attr("cy", globePositionY)

          svg.selectAll("path").attr("d", path);

        }

        svg.on("dblclick", function() {
            if (spinning) {
              stopSpin();
            } else {
              startSpin();
            }
          });

        d3.json("//cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json", function(error, world) {
          if (error) throw error;
          drawGraticule();
          
          g.append("circle")
            .attr("cx", globePositionX)
            .attr("cy", globePositionY)
            .attr("r", 300)
            .style("fill", "none")
            .style("stroke-width", "0.5px")
            .style("stroke", "#006994")

          g.append("g")
            .selectAll("path")    
            .data(topojson.feature(world, world.objects.countries).features)
            .enter().append("path")
            .attr("class","countries")
            .attr("d", path)
            .style("fill", d => color(airports.get(d.id)))
            .style("opacity", "1")
            .style("stroke", "#006994")
            .style("stroke-width", "0.75px")
            .append("title")
            .text(d => d.properties.name + ", " + airports.get(d.id));

          g.append("g").selectAll("path")
            .data(graticular)
            .attr("d", path)
            .style("stroke", "grey")
            .style("stroke-width", ".5px");

          var legend = d3.legendColor()
              .labelFormat(d3.format(".2f"))
              .useClass(true)
              .title("A really really really really really long title")
              .titleWidth(100)
              .scale(color);

          svg.select(".legendQuant")
            .call(legend);
              startSpin();
          /*
          svg.append("g") //add states
            .selectAll("path")
            .data(topojson.feature(us, us.objects.states).features)
            .enter().append("path")
            .attr("class", "states")
            .attr("d", path)
            .on("click", clicked)
            .on("mouseover", function(d) {d3.select(this).style("opacity", "0")})
            .on("mouseout", function(d) {d3.select(this).style("opacity", "1")})
            .append("title")
            .text(d => d.properties.name); 
          
          svg.append("g")
            .append("path")
            .attr("class", "state-borders")
            .attr("d", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));
/*
          d3.selectAll("path")
          .on("click", function() {
            d3.select(this)
            .attr("class", "selected-state");
            console.log(this);
          });*/
        });



        function drawGraticule() {
                const graticule = d3.geoGraticule()
                    .step([10, 10]);

                svg.append("path")
                    .datum(graticule)
                    .attr("class", "graticule")
                    .attr("d", path)
                    .style("fill", "none")
                    .style("stroke", "#ccc")
                    .style("opacity", 0.6);
            }


var timer;

  function startSpin() { 
    
    currentTime =  

    timer = d3.timer(function() {
      var dt = Date.now() - baseTime;
      currentTime = Date.now();

      spinning = true;

      rotate[0] += (velocity[0])
      rotate[1] += (velocity[1])

      rotate[0] = rotate[0] %360;
      rotate[1] = rotate[1] %360;
      
      projection.rotate([rotate[0], rotate[1]]);    

      svg.selectAll("path ").attr("d", path);
     markLocation();

    });
  }

  function markLocation() {
    const markers = g.selectAll("circle")
            .data(airport_location);
            markers
            .enter()
            .append("circle")
            .attr("class", "marker")
            .merge(markers)
            .attr("cx", d => projection([d[0].longitude, d[0].latitude])[0])
            .attr("cy", d => projection([d[0].longitude, d[0].latitude])[1])
            .attr("r", 2)
            .attr('fill', d => {
                        const coordinate = [d[0].longitude, d[0].latitude];
                        gdistance = d3.geoDistance(coordinate, projection.invert([width/2, height/2]));
                        return gdistance > 1.4 ? 'none' : 'blue';
                    });


            g.each(function () {
                    this.parentNode.appendChild(this);
                });
  }

  function stopSpin() {
    timer.stop(); 

    spinning = false;
    stoppedTime = Date.now();
}

        </script>
    <p></p>
  </body>
</html>